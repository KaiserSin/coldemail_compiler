import pandas as pd
import asyncio
from openai import AsyncOpenAI
from dotenv import load_dotenv
import os
import subprocess

subprocess.run(["python3", "reader.py"], check=True)
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")

client = AsyncOpenAI(api_key=api_key)

df = pd.read_csv("companies_filtered.csv", delimiter=";", dtype=str)

EMAIL_TAIL = """Не секрет, что ИИ — прорывная технология, которая помогает оптимизировать бизнес-процессы, особенно сейчас, когда российскому бизнесу важно снижать издержки и держать высокий уровень сервиса. Например:

— Отсекать неподходящие обращения и поднимать наверх тех, кто готов купить.
— Автоматически отвечать клиентам и передавать заявки нужному сотруднику.
— Считывать счета, договоры и анкеты и заносить данные в ваши системы.
— Давать руководителю единую панель показателей (сроки, загрузка, узкие места).

Мы — команда опытных разработчиков, помогаем бизнесу в России внедрять прикладной ИИ без сложных интеграций. Предлагаем начать с пилота на одном процессе и через 2–4 недели увидеть результат в цифрах — время отклика, конверсию и экономию часов.

Давайте созвонимся на 15 минут, чтобы обсудить детали и выбрать процесс для пилота. Вам удобно завтра в 12:00?

С уважением,
команда Celerfide"""

def build_prompt(row):
    return f"""
Ты — эксперт по деловой переписке. Нужно написать персонализированное начало cold email для компании.

Данные компании:
- Наименование: {row['Наименование']}
- ИНН: {row['ИНН']}
- Сайт: {row['Ссылка на сайт']}
- Основной вид деятельности: {row['Основной вид деятельности']}

Сгенерируй 2 предложения для начала cold email без воды, нужно заинтересовать клиента с самого начала. 

Условия: 
- Начало строго с: «Здравствуйте, мы Celerfide, команда разработчиков, которые помогают бизнесу…» 
- Тон деловой и персонализированный. - Используй факты о компании: вид деятельности, специализацию, тип проектов или клиентов. Используй информацию с сайта.
- Запрещено вставлять ссылки и адрес сайта. - Избегай общих фраз («вы успешны», «ваша компания развивается»). 
- Последнее предложение должно логично подводить к тексту: «Не секрет, что ИИ — прорывная технология...» 
- Верни только часть текста ДО «Не секрет, что ИИ» и не включай в ответ «Не секрет, что ИИ».
"""


async def process_row(row, i):
    prompt = build_prompt(row)
    response = await client.responses.create(
        model="gpt-4o-mini",
        input=prompt
    )
    intro = response.output_text.strip()
    full_text = intro + "\n\n" + EMAIL_TAIL
    return {"emails": row["Электронные почты"], "text": full_text}

async def main():

    tasks = [process_row(row, i) for i, row in df.iterrows()]
    results = await asyncio.gather(*tasks)
    final_df = pd.DataFrame(results)
    final_df.to_csv("emails_ready.csv", index=False, sep=";")
    print("Готово! Результаты сохранены в emails_ready.csv")

if __name__ == "__main__":
    asyncio.run(main())
